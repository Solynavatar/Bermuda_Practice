# Project 1

## 一、SM4 算法大致原理

SM4 是中国国家密码管理局制定的分组密码标准，采用分组长度为128位，密钥长度为128位，支持加密和解密。它主要应用于无线局域网和移动通信安全领域。

SM4 的工作流程包括：

1. **分组输入**  
   将128位明文分为4个32位的字，记为`X0, X1, X2, X3`。

2. **轮密钥生成**  
   从128位密钥派生出32个轮密钥`rk[0]`至`rk[31]`。密钥扩展采用非线性变换及固定常量，并用线性变换增强密钥随机性。

3. **32轮迭代加密**  
   每一轮迭代使用一个轮密钥，经过S盒非线性替换和线性变换，对4个字状态进行更新。  
   * 轮函数公式为：$ X_{i+4} = X_i \oplus T\bigl(X_{i+1} \oplus X_{i+2} \oplus X_{i+3} \oplus rk_i \bigr)$
   其中T函数结合S盒和线性变换。

4. **输出结果**  
经过32轮迭代，最终输出的4个32位字经过逆序组合形成128位密文。

5. **解密过程**  
解密与加密类似，只是轮密钥顺序相反。

SM4算法设计保证了强大的非线性和扩散性，抵抗常见的密码分析攻击。

---

## 二、SM4 优化思路说明

针对SM4的算法特点，优化重点主要在性能提升和效率改善：

### 1. 预计算T-表

- 将S盒和线性变换T函数组合成预计算的查找表（T-表），避免运行时重复计算S盒替换和多次旋转异或操作。
- 这样每轮迭代中T函数可以通过查表快速获得结果，大大减少计算量。

### 2. 循环展开与内联函数

- 将32轮迭代进行循环展开，减少循环控制开销。
- 关键函数如轮函数、循环左移等使用`inline`或宏定义，减少函数调用延迟。

### 3. 内存对齐和SIMD指令

- 利用`alignas(32)`保证关键数组内存对齐，利于CPU预取和SIMD指令访问。
- 使用SIMD（如AVX2）并行处理多个数据块，提高批量加密的吞吐量。

### 4. 批量处理接口设计

- 设计批量加密和解密函数，减少单次调用开销，提高数据局部性和缓存命中率。

### 5. 轮密钥计算优化

- 在密钥扩展时使用预计算的T'-表，减少密钥扩展时的计算复杂度。
- 展开循环计算轮密钥，减少循环跳转。

### 6. 代码结构优化

- 避免不必要的内存拷贝和数据转换。
- 合理使用`std::vector`和数组，减少动态内存分配。

---
## 三、运行结果

以下是原始的 SM4 算法运行结果：
![项目1测试结果](../images/proj1test.png '项目1测试结果')

以下是经过优化的 SM4 算法运行结果：
![项目1优化测试结果](../images/proj1test2.png '项目1优化测试结果')

可以看到，经过优化， SM4 加密算法的性能有了十分显著的提升。

---

## 四、总结

SM4的优化主要聚焦在减少重复计算、提高数据并行度和利用CPU硬件特性。通过预计算查找表、循环展开、SIMD并行和内存对齐等方法，可以显著提升SM4的加解密性能，满足高性能安全通信的需求。

